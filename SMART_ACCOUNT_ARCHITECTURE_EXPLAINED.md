# Smart Account Architecture - Complete Explanation

## Overview

Your dApp uses **TWO types of Smart Accounts** in the ERC-7715 + ERC-4337 flow:

1. **Gator Smart Account** (Created automatically by MetaMask)
2. **Session Smart Account** (Created by your app)

---

## ğŸ—ï¸ Smart Account #1: Gator Smart Account (Auto-Created by MetaMask)

### What is it?

- A **MetaMask Smart Account** automatically created by MetaMask when the user requests ERC-7715 permissions
- The user **does NOT manually create this** - MetaMask handles it automatically
- Acts as the **delegator** in the ERC-7715 permission system

### When is it created?

- **Automatically** when the user calls `walletClient.requestExecutionPermissions()` in `permissions-manager.tsx`
- MetaMask detects the permission request and creates the Gator account behind the scenes
- The user doesn't see any UI for this - it's transparent

### Where is it stored?

- Managed by MetaMask internally
- You access it via `permission.signerMeta.delegationManager.delegator` after permission is granted
- **You don't create or manage this account directly**

### Code Reference:

```typescript
// In permissions-manager.tsx, line 108-129
const permissions = await client.requestExecutionPermissions([
  {
    chainId,
    expiry,
    signer: {
      type: "account",
      data: {
        address: sessionSmartAccountAddress, // The delegate (session account)
      },
    },
    // ... permission details
  },
]);

// After this call, MetaMask automatically creates the Gator Smart Account
// The Gator account info is in: permissions[0].signerMeta.delegationManager.delegator
```

---

## ğŸ—ï¸ Smart Account #2: Session Smart Account (Created by Your App)

### What is it?

- A **MetaMask Smart Account** created by your app using `toMetaMaskSmartAccount()`
- Owned by a **session key** (private key generated by your app)
- Used to **execute transactions** with ERC-7715 delegation
- This is the account that actually sends UserOperations

### When is it created?

- **Automatically** when the user clicks "Grant One-Tap Permission" button
- Created in `SessionAccountProvider.tsx` via `createSessionAccount()`
- Happens **before** requesting ERC-7715 permissions

### How is it created?

**Step 1: Generate Session Key**

```typescript
// In SessionAccountProvider.tsx, line 124-130
const sessionPrivateKey = generatePrivateKey(); // Random private key
const account = privateKeyToAccount(sessionPrivateKey); // EOA from private key
localStorage.setItem(SESSION_KEY_STORAGE_KEY, sessionPrivateKey); // Save to localStorage
```

**Step 2: Create Smart Account from Session Key**

```typescript
// In SessionAccountProvider.tsx, line 134-140
const smartAccount = await toMetaMaskSmartAccount({
  client: publicClient,
  implementation: Implementation.Hybrid, // ERC-4337 compatible
  deployParams: [account.address, [], [], []], // Owner = session key EOA
  deploySalt: "0x",
  signer: { account }, // Session key signs for the smart account
});
```

**What this does:**

- Creates a **deterministic smart account address** based on the session key
- The smart account is **owned by** the session key EOA
- Uses **Hybrid implementation** (ERC-4337 compatible)
- The account is **not deployed on-chain yet** - it will be deployed on first transaction

### Where is it stored?

- **Session Key (Private Key)**: Stored in `localStorage` as `"prophet_session_key"`
- **Smart Account Object**: Stored in React state (`sessionSmartAccount`)
- **Smart Account Address**: Stored in React state (`sessionSmartAccountAddress`)

### User Flow to Get Session Smart Account:

1. User clicks **"Setup One-Tap Betting"** button in sidebar/mobile menu
2. `PermissionsManager` component calls `createSessionAccount()` if not already created
3. `SessionAccountProvider` generates a private key (or loads from localStorage)
4. `SessionAccountProvider` creates the smart account using `toMetaMaskSmartAccount()`
5. Smart account is ready to use (stored in state and localStorage)

**Code Flow:**

```
User clicks button
  â†“
permissions-manager.tsx: handleGrantPermission()
  â†“
Checks: if (!sessionSmartAccount) await createSessionAccount()
  â†“
SessionAccountProvider.createSessionAccount()
  â†“
Generates private key â†’ Creates smart account â†’ Stores in state/localStorage
  â†“
Session account ready!
```

---

## ğŸ”„ Complete User Flow

### Step 1: User Connects Wallet

- User connects MetaMask (EOA)
- No smart accounts exist yet

### Step 2: User Clicks "Setup One-Tap Betting"

- App checks if session smart account exists
- If not, **creates session smart account** (automatic, no user action needed)
  - Generates session key
  - Creates smart account from session key
  - Stores in localStorage

### Step 3: User Grants Permission

- User clicks "Grant Permission" â†’ Opens modal
- User enters amount and duration
- User clicks "Continue to MetaMask"
- **MetaMask popup appears** (this is the ONLY popup)
- User approves permission request
- **MetaMask automatically creates Gator Smart Account** (transparent to user)
- Permission is granted from Gator â†’ Session account

### Step 4: User Places Bets (No More Popups!)

- User places bets normally
- Transactions are executed via `sendUserOperationWithDelegation()`
- Session smart account signs transactions (using session key)
- ERC-7715 delegation validates permissions
- Pimlico paymaster sponsors gas
- **No MetaMask popups!**

---

## ğŸ“ Where Smart Accounts Are Used

### 1. Session Smart Account Usage

**File**: `PROPHET/frontend/src/hooks/useSessionTransaction.ts`

```typescript
// Line 189-199
const userOpHash = await client.sendUserOperationWithDelegation({
  account: sessionSmartAccount, // âœ… Session smart account executes transactions
  calls: [...],
  permissionsContext: permission.context, // ERC-7715 context
  delegationManager, // Contains Gator account info
  ...fee,
});
```

**What it does:**

- Uses `sessionSmartAccount` to sign and send UserOperations
- The session smart account is the **sender** of all transactions
- ERC-7715 delegation allows it to spend user's tokens

### 2. Gator Smart Account Usage

**File**: `PROPHET/frontend/src/hooks/useSessionTransaction.ts`

```typescript
// Line 137-141
const { signerMeta } = permission;
const delegationManager = signerMeta?.delegationManager; // Contains Gator account info

// delegationManager.delegator = Gator Smart Account address
// delegationManager.delegate = Session Smart Account address
```

**What it does:**

- Gator account info is passed to `sendUserOperationWithDelegation()`
- The bundler validates that Gator has granted permission to Session account
- This happens **automatically** - you don't interact with Gator account directly

---

## ğŸ¯ Key Points

### 1. User Doesn't Create Smart Accounts Manually

- **Session Smart Account**: Created automatically by app when user clicks "Setup One-Tap Betting"
- **Gator Smart Account**: Created automatically by MetaMask when user grants permission
- User only sees **one MetaMask popup** (permission approval)

### 2. Smart Account Creation is Deterministic

- Session smart account address is **deterministic** based on:
  - Session key private key
  - `deploySalt` (currently `"0x"`)
  - `deployParams` (session key EOA address)
- Same session key = same smart account address

### 3. Smart Accounts Are Not Deployed Immediately

- Smart accounts are **counterfactual** - they have addresses but aren't deployed on-chain
- They are **deployed automatically** on the first transaction
- This is handled by the bundler (Pimlico)

### 4. Two Smart Accounts, Different Roles

- **Gator Smart Account**: Delegator (grants permissions)
- **Session Smart Account**: Delegate (executes transactions)
- Both are MetaMask Smart Accounts (ERC-4337 compatible)

---

## ğŸ” Code Locations

### Session Smart Account Creation

- **Provider**: `PROPHET/frontend/src/providers/SessionAccountProvider.tsx`
- **Usage**: `PROPHET/frontend/src/components/wallet/permissions-manager.tsx`
- **Transaction Execution**: `PROPHET/frontend/src/hooks/useSessionTransaction.ts`

### Gator Smart Account

- **Created by**: MetaMask (automatic, when requesting permissions)
- **Accessed via**: `permission.signerMeta.delegationManager.delegator`
- **Used in**: `PROPHET/frontend/src/hooks/useSessionTransaction.ts` (line 137-141)

---

## ğŸ“Š Summary Table

| Smart Account | Created By | When                          | Purpose                          | User Action                       |
| ------------- | ---------- | ----------------------------- | -------------------------------- | --------------------------------- |
| **Gator**     | MetaMask   | When granting permission      | Delegator (grants permissions)   | None (automatic)                  |
| **Session**   | Your App   | When clicking "Setup One-Tap" | Delegate (executes transactions) | Click button (automatic creation) |

---

## ğŸ¬ Visual Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User Connects MetaMask (EOA)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. User Clicks "Setup One-Tap Betting"                     â”‚
â”‚    â†’ App creates Session Smart Account (automatic)          â”‚
â”‚    â†’ Session key generated & stored in localStorage        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. User Grants Permission (MetaMask popup)                 â”‚
â”‚    â†’ MetaMask creates Gator Smart Account (automatic)       â”‚
â”‚    â†’ Permission granted: Gator â†’ Session                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. User Places Bets (No popups!)                           â”‚
â”‚    â†’ Session Smart Account executes transactions            â”‚
â”‚    â†’ ERC-7715 validates permissions                         â”‚
â”‚    â†’ Pimlico sponsors gas                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Answer to Your Questions

### Q: Are we using smart accounts?

**A: Yes! Two smart accounts:**

1. Gator Smart Account (auto-created by MetaMask)
2. Session Smart Account (created by your app)

### Q: How are they created?

**A:**

- **Gator**: Automatically by MetaMask when user grants permission
- **Session**: By your app using `toMetaMaskSmartAccount()` with a generated session key

### Q: What does the user do to get the smart account?

**A:**

- **Gator**: Nothing! Created automatically when granting permission
- **Session**: User clicks "Setup One-Tap Betting" â†’ App creates it automatically (no user action beyond clicking)

### Q: Where are they used?

**A:**

- **Session Smart Account**: Used in `useSessionTransaction.ts` to execute all transactions
- **Gator Smart Account**: Info passed to bundler for permission validation (automatic)

---

## ğŸš€ Next Steps

The smart account architecture is already set up correctly. The current issue is with paymaster stub validation, which we're fixing by removing `getPaymasterStubData` for delegation operations.
